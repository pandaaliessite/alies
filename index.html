<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–ª—ñ–∞—Å: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ö–æ–º–∞–Ω–¥ —Ç–∞ –ì—Ä–∞</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ Firebase (–±—É–¥—É—Ç—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø—ñ–∑–Ω—ñ—à–µ)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null; // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-alias-app'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞–¥–∞–Ω–∏–π __app_id

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Firebase
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Please ensure __firebase_config is provided.");
                    document.getElementById('loading-message').textContent = "–ü–æ–º–∏–ª–∫–∞: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase –≤—ñ–¥—Å—É—Ç–Ω—è.";
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase Authenticated. User ID:", window.userId);
                        document.getElementById('loading-message').style.display = 'none'; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                        loadState(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–∞–Ω –≥—Ä–∏ –ø—ñ—Å–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
                    } else {
                        // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–∞–¥–∞–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ —É–≤—ñ–π—Ç–∏ –∑ –Ω–∏–º
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π –∞–±–æ –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞, —Å–ø—Ä–æ–±—É—î–º–æ –∞–Ω–æ–Ω—ñ–º–Ω–æ
                                try {
                                    await signInAnonymously(window.auth);
                                    console.log("Signed in anonymously after custom token failure.");
                                } catch (anonError) {
                                    console.error("Error signing in anonymously:", anonError);
                                    document.getElementById('loading-message').textContent = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó Firebase.";
                                }
                            }
                        } else {
                            // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–¥–∞–Ω–æ, —É–≤—ñ–π–¥–µ–º–æ –∞–Ω–æ–Ω—ñ–º–Ω–æ
                            try {
                                await signInAnonymously(window.auth);
                                console.log("Signed in anonymously.");
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                document.getElementById('loading-message').textContent = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó Firebase.";
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('loading-message').textContent = "–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase.";
            }
        });
    </script>

    <style>
        /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ç—ñ–ª–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–æ–¥–∞—Ç–∫—É */
        body {
            font-family: 'Inter', sans-serif; /* –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —à—Ä–∏—Ñ—Ç—É Inter */
            background-color: #f0f4f8; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ 100% –≤—ñ–¥ –≤–∏—Å–æ—Ç–∏ –≤—ñ–∫–Ω–∞ */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s ease; /* –ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ —Ñ–æ–Ω—É */
        }
        body.dark-mode {
            background-color: #1a202c; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
        }
        #app-container {
            background-color: #ffffff; /* –ë—ñ–ª–∏–π —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            padding: 30px;
            border-radius: 15px; /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* –¢—ñ–Ω—å */
            width: 100%;
            max-width: 700px; /* –ó–±—ñ–ª—å—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px; /* –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode #app-container {
            background-color: #2d3748; /* –¢–µ–º–Ω—ñ—à–∏–π —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); /* –°–∏–ª—å–Ω—ñ—à–∞ —Ç—ñ–Ω—å */
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–∫—Ü—ñ–π, —è–∫—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è/—Ö–æ–≤–∞—é—Ç—å—Å—è JavaScript'–æ–º */
        .section {
            display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ */
            flex-direction: column;
            gap: 15px;
        }
        .section.active {
            display: flex; /* –ê–∫—Ç–∏–≤–Ω—ñ —Å–µ–∫—Ü—ñ—ó –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è */
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ª—ñ–≤ –≤–≤–æ–¥—É —Ç–∞ –≤–∏–±–æ—Ä—É */
        input[type="text"], input[type="number"], select, textarea {
            padding: 12px;
            border: 1px solid #cbd5e0; /* –°—ñ—Ä–∞ —Ä–∞–º–∫–∞ */
            border-radius: 8px; /* –ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏ */
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box; /* –í–∫–ª—é—á–∞—î–º–æ padding —ñ border —É —à–∏—Ä–∏–Ω—É */
            transition: border-color 0.2s, background-color 0.3s, color 0.3s; /* –ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –∫–æ–ª—å–æ—Ä—É —Ä–∞–º–∫–∏ */
        }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #4a5568; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω –¥–ª—è –ø–æ–ª—ñ–≤ –≤–≤–æ–¥—É */
            border-color: #4a5568; /* –¢–µ–º–Ω–∞ —Ä–∞–º–∫–∞ */
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç */
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π outline */
            border-color: #6366f1; /* –ö–æ–ª—ñ—Ä —Ä–∞–º–∫–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* –¢—ñ–Ω—å –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ */
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        button {
            background-color: #6366f1; /* –°–∏–Ω—ñ–π —Ñ–æ–Ω */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; /* –ü–ª–∞–≤–Ω—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏ */
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); /* –¢—ñ–Ω—å –∫–Ω–æ–ø–∫–∏ */
        }
        button:hover {
            background-color: #4f46e5; /* –¢–µ–º–Ω—ñ—à–∏–π —Å–∏–Ω—ñ–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
            transform: translateY(-1px); /* –ù–µ–≤–µ–ª–∏–∫–∏–π –ø—ñ–¥–π–æ–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        }
        button:disabled {
            background-color: #a7a7a7; /* –°—ñ—Ä–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ */
            cursor: not-allowed; /* –ö—É—Ä—Å–æ—Ä "–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ" */
            box-shadow: none;
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É –∫–æ–º–∞–Ω–¥ */
        .teams-columns-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .teams-columns-container {
                flex-direction: row;
                justify-content: space-around;
            }
        }

        .team-list-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between team cards in a column */
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–∫–∏ –∫–æ–º–∞–Ω–¥–∏ */
        .team-card {
            background-color: #e0e7ff; /* –°–≤—ñ—Ç–ª–æ-—ñ–Ω–¥–∏–≥–æ–≤–∏–π —Ñ–æ–Ω */
            padding: 15px;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* –õ–µ–≥–∫–∞ —Ç—ñ–Ω—å */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .team-card {
            background-color: #4a5568; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω –¥–ª—è –∫–∞—Ä—Ç–∫–∏ –∫–æ–º–∞–Ω–¥–∏ */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .team-card h3 {
            font-weight: bold;
            color: #4338ca; /* –¢–µ–º–Ω–æ-—ñ–Ω–¥–∏–≥–æ–≤–∏–π –∫–æ–ª—ñ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        body.dark-mode .team-card h3 {
            color: #a7d9f7; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π –∫–æ–ª—ñ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ —Ç–µ–º–Ω—ñ–π —Ç–µ–º—ñ */
        }
        .team-card ul {
            list-style: none; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ —Å–ø–∏—Å–∫—É */
            padding: 0;
            margin: 0;
        }
        .team-card ul li {
            background-color: #c7d2fe; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —ñ–Ω–¥–∏–≥–æ–≤–∏–π —Ñ–æ–Ω –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Å–ø–∏—Å–∫—É */
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #312e81; /* –¢–µ–º–Ω–æ-—Å–∏–Ω—ñ–π –∫–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .team-card ul li {
            background-color: #6366f1; /* –¢–µ–º–Ω—ñ—à–∏–π —ñ–Ω–¥–∏–≥–æ–≤–∏–π —Ñ–æ–Ω –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Å–ø–∏—Å–∫—É */
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Ç–µ–∫—Å—Ç */
        }
        .team-card ul li:last-child {
            margin-bottom: 0;
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—ñ–∫–Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        #message-box {
            background-color: #fff3cd; /* –ñ–æ–≤—Ç–∏–π —Ñ–æ–Ω */
            color: #856404; /* –¢–µ–º–Ω–æ-–∂–æ–≤—Ç–∏–π —Ç–µ–∫—Å—Ç */
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode #message-box {
            background-color: #4a2d00; /* –¢–µ–º–Ω–∏–π –∂–æ–≤—Ç–∏–π —Ñ–æ–Ω */
            color: #ffda8b; /* –°–≤—ñ—Ç–ª–∏–π –∂–æ–≤—Ç–∏–π —Ç–µ–∫—Å—Ç */
        }
        #message-box.active {
            display: block; /* –ê–∫—Ç–∏–≤–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è */
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ–≥—Ä–æ–≤–æ—ó —Å–µ–∫—Ü—ñ—ó */
        #game-section {
            text-align: center;
        }
        #current-word {
            font-size: 3.5rem; /* –í–µ–ª–∏–∫–∏–π —Ä–æ–∑–º—ñ—Ä —Å–ª–æ–≤–∞ */
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            min-height: 100px; /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è —Å–ª–æ–≤–∞ */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode #current-word {
            background-color: #1a202c; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω */
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        #timer {
            font-size: 4rem; /* –î—É–∂–µ –≤–µ–ª–∏–∫–∏–π —Ç–∞–π–º–µ—Ä */
            font-weight: bolder;
            color: #ef4444; /* –ß–µ—Ä–≤–æ–Ω–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ */
            margin-bottom: 20px;
            animation: pulse 1s infinite alternate; /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ */
        }
        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.9; }
        }
        #current-team-turn {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        body.dark-mode #current-team-turn {
            color: #a7d9f7; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Å–∏–Ω—ñ–π –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
        }
        .game-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .game-buttons button {
            flex: 1;
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 10px;
        }
        #correct-btn {
            background-color: #22c55e; /* –ó–µ–ª–µ–Ω–∏–π –¥–ª—è "–í—ñ—Ä–Ω–æ" */
        }
        #correct-btn:hover {
            background-color: #16a34a;
        }
        #skip-btn {
            background-color: #f97316; /* –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π –¥–ª—è "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏" */
        }
        #skip-btn:hover {
            background-color: #ea580c;
        }
        #end-game-btn {
            background-color: #dc2626; /* –ß–µ—Ä–≤–æ–Ω–∏–π –¥–ª—è "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –≥—Ä—É" */
            margin-top: 20px;
        }
        #end-game-btn:hover {
            background-color: #b91c1c;
        }
        #start-round-btn, #start-next-round-btn { /* –û–±'—î–¥–Ω–∞–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –æ–±–æ—Ö –∫–Ω–æ–ø–æ–∫ –ø–æ—á–∞—Ç–∫—É —Ä–∞—É–Ω–¥—É */
            background-color: #10b981; /* –ó–µ–ª–µ–Ω–∏–π –¥–ª—è "–ü–æ—á–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä–∞—É–Ω–¥" */
            margin-top: 20px;
            display: none; /* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ */
        }
        #start-round-btn:hover, #start-next-round-btn:hover {
            background-color: #059669;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª—ñ–≤ –∫–æ–º–∞–Ω–¥ –ø—ñ–¥ —á–∞—Å –≥—Ä–∏ */
        #game-scores {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f4f8;
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode #game-scores {
            background-color: #1a202c; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω –¥–ª—è —Ä–∞—Ö—É–Ω–∫—ñ–≤ */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .game-score-item {
            font-size: 1.1rem;
            font-weight: bold;
            color: #444;
            transition: color 0.3s ease;
        }
        body.dark-mode .game-score-item {
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç */
        }
        .game-score-item span {
            color: #6366f1;
            font-size: 1.3rem;
            transition: color 0.3s ease;
        }
        body.dark-mode .game-score-item span {
            color: #a7d9f7; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Å–∏–Ω—ñ–π */
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—ñ–¥—Å—É–º–∫—ñ–≤ —Ä–∞—É–Ω–¥—É */
        #round-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f7ff; /* –°–≤—ñ—Ç–ª–æ-–±–ª–∞–∫–∏—Ç–Ω–∏–π —Ñ–æ–Ω */
            border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            text-align: center; /* –¶–µ–Ω—Ç—Ä—É—î–º–æ –≤–º—ñ—Å—Ç, –≤–∫–ª—é—á–∞—é—á–∏ –∫–Ω–æ–ø–∫—É –û–ö */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode #round-summary {
            background-color: #2a3340; /* –¢–µ–º–Ω–∏–π –±–ª–∞–∫–∏—Ç–Ω–∏–π —Ñ–æ–Ω */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        #round-summary h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff; /* –°–∏–Ω—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            margin-bottom: 15px;
            text-align: center;
            transition: color 0.3s ease;
        }
        body.dark-mode #round-summary h3 {
            color: #7ab8ff; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Å–∏–Ω—ñ–π */
        }
        #words-in-round-list {
            text-align: left; /* –°–ª–æ–≤–∞ –∑–∞–ª–∏—à–∞—î–º–æ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–º–∏ –ø–æ –ª—ñ–≤–æ–º—É –∫—Ä–∞—é */
        }
        .word-score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #cceeff;
            transition: border-color 0.3s ease;
        }
        body.dark-mode .word-score-item {
            border-bottom: 1px dashed #3a4a5c; /* –¢–µ–º–Ω—ñ—à–∞ –º–µ–∂–∞ */
        }
        .word-score-item:last-child {
            border-bottom: none;
        }
        .word-score-item span {
            font-weight: bold;
            color: #333;
            transition: color 0.3s ease;
        }
        body.dark-mode .word-score-item span {
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç */
        }
        .word-score-item .score-controls button {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
            border-radius: 5px;
            box-shadow: none;
            background-color: #6c757d; /* –°—ñ—Ä—ñ –∫–Ω–æ–ø–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
            transition: background-color 0.3s ease;
        }
        body.dark-mode .word-score-item .score-controls button {
            background-color: #5a6268; /* –¢–µ–º–Ω—ñ—à—ñ —Å—ñ—Ä—ñ –∫–Ω–æ–ø–∫–∏ */
        }
        .word-score-item .score-controls button.active {
             background-color: #007bff; /* –ê–∫—Ç–∏–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—è */
        }
        body.dark-mode .word-score-item .score-controls button.active {
             background-color: #7ab8ff; /* –ê–∫—Ç–∏–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å–≤—ñ—Ç–ª—ñ—à–∞ —Å–∏–Ω—è */
        }
        .word-score-item .score-controls button:hover {
            background-color: #5a6268;
        }
        body.dark-mode .word-score-item .score-controls button:hover {
            background-color: #6c757d;
        }
        .word-score-item .current-word-score {
            font-weight: bold;
            margin-left: 10px;
            min-width: 25px; /* –©–æ–± –Ω–µ "—Å—Ç—Ä–∏–±–∞–ª–æ" –ø—Ä–∏ –∑–º—ñ–Ω—ñ */
            text-align: right;
            transition: color 0.3s ease;
        }
        body.dark-mode .word-score-item .current-word-score {
            color: #e2e8f0; /* –°–≤—ñ—Ç–ª–∏–π —Ç–µ–∫—Å—Ç */
        }
        #confirm-round-summary-btn { /* –°—Ç–∏–ª—å –¥–ª—è –Ω–æ–≤–æ—ó –∫–Ω–æ–ø–∫–∏ –û–ö */
            background-color: #4CAF50; /* –ó–µ–ª–µ–Ω–∏–π */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        #confirm-round-summary-btn:hover {
            background-color: #45a049;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ù–µ –ø—ñ–¥–≥–ª—è–¥—É–π" */
        #peeking-message {
            font-size: 2.5rem;
            font-weight: bold;
            color: #cc0000; /* –ß–µ—Ä–≤–æ–Ω–∏–π –∫–æ–ª—ñ—Ä */
            margin: 30px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff0f0;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode #peeking-message {
            background-color: #4a1c1c; /* –¢–µ–º–Ω–∏–π —á–µ—Ä–≤–æ–Ω–∏–π —Ñ–æ–Ω */
            color: #ff9999; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —á–µ—Ä–≤–æ–Ω–∏–π —Ç–µ–∫—Å—Ç */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        #loading-message {
            font-size: 1.5rem;
            color: #6366f1;
            text-align: center;
            margin-top: 50px;
        }
        body.dark-mode #loading-message {
            color: #a7d9f7;
        }
        .host-display-text { /* –°—Ç–∏–ª—å –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ö–æ—Å—Ç–∞ */
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
            text-align: center;
            transition: color 0.3s ease;
        }
        body.dark-mode .host-display-text {
            color: #a0aec0; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Å—ñ—Ä–∏–π */
        }
        #theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #6366f1;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        #theme-toggle:hover {
            background-color: #4f46e5;
            transform: scale(1.05);
        }
        body.dark-mode #theme-toggle {
            background-color: #a7d9f7; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Å–∏–Ω—ñ–π –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
            color: #2d3748; /* –¢–µ–º–Ω–∏–π —Ç–µ–∫—Å—Ç */
        }
        body.dark-mode #theme-toggle:hover {
            background-color: #8ac0e0;
        }
    </style>
</head>
<body>
    <div id="app-container" class="rounded-xl shadow-lg p-8 bg-white flex flex-col gap-6">
        <div id="loading-message">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

        <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ç–µ–º–∏ -->
        <button id="theme-toggle">üåô</button>

        <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ω—ñ–∫–Ω–µ–π–º—É -->
        <div id="nickname-section" class="section">
            <label for="nickname-input" class="text-gray-700 text-lg font-medium mb-2">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω—ñ–∫–Ω–µ–π–º:</label>
            <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º" class="rounded-lg p-3 border border-gray-300 focus:ring-2 focus:ring-indigo-500">
            <button id="continue-btn" class="rounded-lg bg-indigo-600 text-white p-3 text-lg font-semibold hover:bg-indigo-700 transition duration-200">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –¥—ñ–π (—Å—Ç–≤–æ—Ä–∏—Ç–∏/–ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è/–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–æ–≤–∞/–ø–æ—á–∞—Ç–∏ –≥—Ä—É) -->
        <div id="main-actions-section" class="section">
            <p class="text-gray-700 text-lg mb-4">–ü—Ä–∏–≤—ñ—Ç, <span id="display-nickname" class="font-bold text-indigo-600"></span>! –û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:</p>
            <p id="host-display-main" class="host-display-text">–•–æ—Å—Ç: </p> <!-- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ö–æ—Å—Ç–∞ –Ω–∞ –≥–æ–ª–æ–≤–Ω–æ–º—É –µ–∫—Ä–∞–Ω—ñ -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="create-team-option-btn" class="flex-1 rounded-lg bg-green-600 text-white p-3 text-lg font-semibold hover:bg-green-700 transition duration-200">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É</button>
                <button id="join-team-option-btn" class="flex-1 rounded-lg bg-blue-600 text-white p-3 text-lg font-semibold hover:bg-blue-700 transition duration-200">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –∫–æ–º–∞–Ω–¥–∏</button>
            </div>
            <button id="load-words-option-btn" class="rounded-lg bg-purple-600 text-white p-3 text-lg font-semibold hover:bg-purple-700 transition duration-200 mt-4">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–æ–≤–∞</button>
            <button id="start-game-btn" class="rounded-lg bg-red-600 text-white p-3 text-lg font-semibold hover:bg-red-700 transition duration-200 mt-4" disabled>–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
            <button id="back-to-nickname-btn" class="rounded-lg bg-gray-500 text-white p-3 text-base font-semibold hover:bg-gray-600 transition duration-200 mt-4">–ó–º—ñ–Ω–∏—Ç–∏ –Ω—ñ–∫–Ω–µ–π–º</button>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∫–æ–º–∞–Ω–¥ -->
        <div id="create-team-section" class="section">
            <label for="num-teams-input" class="text-gray-700 text-lg font-medium mb-2">–°–∫—ñ–ª—å–∫–∏ –∫–æ–º–∞–Ω–¥ –≤–∏ —Ö–æ—á–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ (2-5)?</label>
            <input type="number" id="num-teams-input" min="2" max="5" value="2" class="rounded-lg p-3 border border-gray-300 focus:ring-2 focus:ring-indigo-500">
            <button id="create-teams-btn" class="rounded-lg bg-indigo-600 text-white p-3 text-lg font-semibold hover:bg-indigo-700 transition duration-200">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
            <button id="back-to-main-actions-btn-from-create" class="rounded-lg bg-gray-500 text-white p-3 text-base font-semibold hover:bg-gray-600 transition duration-200">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —ñ—Å–Ω—É—é—á–æ—ó –∫–æ–º–∞–Ω–¥–∏ -->
        <div id="join-team-section" class="section">
            <label for="team-select" class="text-gray-700 text-lg font-medium mb-2">–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è:</label>
            <select id="team-select" class="rounded-lg p-3 border border-gray-300 focus:ring-2 focus:ring-indigo-500">
                <!-- –û–ø—Ü—ñ—ó –∫–æ–º–∞–Ω–¥ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ JavaScript'–æ–º -->
            </select>
            <button id="join-selected-team-btn" class="rounded-lg bg-blue-600 text-white p-3 text-lg font-semibold hover:bg-blue-700 transition duration-200">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
            <button id="back-to-main-actions-btn-from-join" class="rounded-lg bg-gray-500 text-white p-3 text-base font-semibold hover:bg-gray-600 transition duration-200">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ª—ñ–≤ -->
        <div id="word-input-section" class="section">
            <label for="words-textarea" class="text-gray-700 text-lg font-medium mb-2">–í—Å—Ç–∞–≤—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –≥—Ä–∏ (–æ–¥–Ω–µ —Å–ª–æ–≤–æ –Ω–∞ —Ä—è–¥–æ–∫):</label>
            <textarea id="words-textarea" rows="10" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥:&#10;–Ø–±–ª—É–∫–æ&#10;–ú–∞—à–∏–Ω–∞&#10;–°–æ–Ω—Ü–µ&#10;–ö–Ω–∏–≥–∞" class="rounded-lg p-3 border border-gray-300 focus:ring-2 focus:ring-indigo-500"></textarea>
            <button id="load-words-btn" class="rounded-lg bg-purple-600 text-white p-3 text-lg font-semibold hover:bg-purple-700 transition duration-200">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–æ–≤–∞</button>
            <button id="back-to-main-actions-btn-from-words" class="rounded-lg bg-gray-500 text-white p-3 text-base font-semibold hover:bg-gray-600 transition duration-200">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –ë–ª–æ–∫ –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É -->
        <p id="message-box" class="rounded-lg p-3 text-center"></p>

        <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ —Ç–∞ —ó—Ö–Ω—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ -->
        <div id="teams-display-section" class="section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–ü–æ—Ç–æ—á–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</h2>
            <div class="teams-columns-container">
                <div id="left-teams-list" class="team-list-column"></div>
                <div id="right-teams-list" class="team-list-column"></div>
            </div>
        </div>

        <!-- –Ü–≥—Ä–æ–≤–∞ —Å–µ–∫—Ü—ñ—è -->
        <div id="game-section" class="section">
            <p id="current-team-turn-game" class="text-indigo-700 text-xl font-semibold">–•—ñ–¥ –∫–æ–º–∞–Ω–¥–∏: <span class="font-bold text-indigo-900"></span></p>
            <p id="host-display-game" class="host-display-text">–•–æ—Å—Ç: </p> <!-- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ö–æ—Å—Ç–∞ –≤ —ñ–≥—Ä–æ–≤—ñ–π —Å–µ–∫—Ü—ñ—ó -->
            <div id="game-scores" class="flex justify-around mb-6">
                <!-- –†–∞—Ö—É–Ω–∫–∏ –∫–æ–º–∞–Ω–¥ –±—É–¥—É—Ç—å —Ç—É—Ç -->
            </div>
            <div id="timer" class="text-red-600 text-6xl font-extrabold mb-8">60</div>
            <div id="current-word" class="bg-blue-50 text-blue-800 text-5xl font-bold p-8 rounded-2xl shadow-md"></div>
            <div id="peeking-message" style="display: none;">–ù–µ –ø—ñ–¥–≥–ª—è–¥—É–π, –ª–æ—Ö!</div>
            <div class="game-buttons flex flex-col sm:flex-row gap-4">
                <button id="correct-btn" class="flex-1 bg-green-500 text-white p-4 text-xl font-bold rounded-lg hover:bg-green-600 transition duration-200">–í—ñ—Ä–Ω–æ</button>
                <button id="skip-btn" class="flex-1 bg-orange-500 text-white p-4 text-xl font-bold rounded-lg hover:bg-orange-600 transition duration-200">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Å–ª–æ–≤–æ</button>
            </div>
            <div id="round-summary" style="display: none;">
                <h3>–ü—ñ–¥—Å—É–º–∫–∏ —Ä–∞—É–Ω–¥—É –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ <span id="summary-team-name"></span>:</h3>
                <div id="words-in-round-list">
                    <!-- –°–ª–æ–≤–∞ –∑ –±–∞–ª–∞–º–∏ —Ç–∞ –∫–Ω–æ–ø–∫–∞–º–∏ –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è –±—É–¥—É—Ç—å —Ç—É—Ç -->
                </div>
                <button id="confirm-round-summary-btn" class="rounded-lg">–û–ö</button>
            </div>
            <button id="start-round-btn" class="rounded-lg bg-green-500 text-white p-3 text-lg font-semibold hover:bg-green-600 transition duration-200 mt-6">–ü–æ—á–∞—Ç–∏ —Ä–∞—É–Ω–¥</button>
            <button id="start-next-round-btn" class="rounded-lg bg-green-500 text-white p-3 text-lg font-semibold hover:bg-green-600 transition duration-200 mt-6">–ü–æ—á–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä–∞—É–Ω–¥</button>
            <button id="end-game-btn" class="rounded-lg bg-red-600 text-white p-3 text-lg font-semibold hover:bg-red-700 transition duration-200 mt-6">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –≥—Ä—É</button>
        </div>
    </div>

    <script type="module">
        // –Ü–º–ø–æ—Ä—Ç–∏ Firebase SDK (–≤—ñ–∑—å–º–µ–º–æ –∑ window –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
        let db;
        let auth;
        let userId;
        let appId;

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ HTML-–µ–ª–µ–º–µ–Ω—Ç–∏
        const nicknameInput = document.getElementById('nickname-input');
        const continueBtn = document.getElementById('continue-btn');
        const displayNickname = document.getElementById('display-nickname');
        const nicknameSection = document.getElementById('nickname-section');
        const mainActionsSection = document.getElementById('main-actions-section');
        const createTeamOptionBtn = document.getElementById('create-team-option-btn');
        const joinTeamOptionBtn = document.getElementById('join-team-option-btn');
        const backToNicknameBtn = document.getElementById('back-to-nickname-btn');
        const createTeamSection = document.getElementById('create-team-section');
        const numTeamsInput = document.getElementById('num-teams-input');
        const createTeamsBtn = document.getElementById('create-teams-btn');
        const backToMainActionsBtnFromCreate = document.getElementById('back-to-main-actions-btn-from-create');
        const joinTeamSection = document.getElementById('join-team-section');
        const teamSelect = document.getElementById('team-select');
        const joinSelectedTeamBtn = document.getElementById('join-selected-team-btn');
        const backToMainActionsBtnFromJoin = document.getElementById('back-to-main-actions-btn-from-join');
        const teamsDisplaySection = document.getElementById('teams-display-section');
        const leftTeamsList = document.getElementById('left-teams-list');
        const rightTeamsList = document.getElementById('right-teams-list');
        const messageBox = document.getElementById('message-box');
        const loadingMessage = document.getElementById('loading-message');
        const themeToggle = document.getElementById('theme-toggle');


        // –ï–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –≥—Ä–∏
        const loadWordsOptionBtn = document.getElementById('load-words-option-btn');
        const wordInputSection = document.getElementById('word-input-section');
        const wordsTextarea = document.getElementById('words-textarea');
        const loadWordsBtn = document.getElementById('load-words-btn');
        const backToMainActionsBtnFromWords = document.getElementById('back-to-main-actions-btn-from-words');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameSection = document.getElementById('game-section');
        const currentTeamTurnDisplayGame = document.getElementById('current-team-turn-game').querySelector('span');
        const gameScoresDisplay = document.getElementById('game-scores');
        const timerDisplay = document.getElementById('timer');
        const currentWordDisplay = document.getElementById('current-word');
        const peekingMessage = document.getElementById('peeking-message');
        const correctBtn = document.getElementById('correct-btn');
        const skipBtn = document.getElementById('skip-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const startRoundBtn = document.getElementById('start-round-btn');
        const startNextRoundBtn = document.getElementById('start-next-round-btn');
        const roundSummaryDiv = document.getElementById('round-summary');
        const summaryTeamName = document.getElementById('summary-team-name');
        const wordsInRoundList = document.getElementById('words-in-round-list');
        const confirmRoundSummaryBtn = document.getElementById('confirm-round-summary-btn');
        const hostDisplayMain = document.getElementById('host-display-main'); // –ï–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ö–æ—Å—Ç–∞ –Ω–∞ –≥–æ–ª–æ–≤–Ω–æ–º—É –µ–∫—Ä–∞–Ω—ñ
        const hostDisplayGame = document.getElementById('host-display-game'); // –ï–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ö–æ—Å—Ç–∞ –≤ —ñ–≥—Ä–æ–≤—ñ–π —Å–µ–∫—Ü—ñ—ó


        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –≥—Ä–∏
        let teams = []; // –ú–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥: [{ id: 'docId', name: '–ö–æ–º–∞–Ω–¥–∞ 1', members: ['–ì—Ä–∞–≤–µ—Ü—å1'], score: 0 }]
        let currentPlayer = { nickname: '', team: '', isHost: false }; // –ù—ñ–∫–Ω–µ–π–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è, –π–æ–≥–æ –∫–æ–º–∞–Ω–¥–∞ —Ç–∞ —á–∏ —î –≤—ñ–Ω —Ö–æ—Å—Ç–æ–º
        let words = []; // –ú–∞—Å–∏–≤ —Å–ª—ñ–≤ –¥–ª—è –≥—Ä–∏ (–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π, –Ω–µ–∑–º—ñ–Ω–Ω–∏–π)
        let shuffledWords = []; // –ü–µ—Ä–µ–º—ñ—à–∞–Ω–∏–π –º–∞—Å–∏–≤ —Å–ª—ñ–≤ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥–µ–π–º–ø–ª–µ—é
        let currentWordIndex = 0;
        let currentTeamIndex = 0;
        let gameTimer = 60; // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —á–∞—Å –Ω–∞ —Ö—ñ–¥
        let timerInterval;
        let gameActive = false; // –ß–∏ –∞–∫—Ç–∏–≤–Ω–∞ –≥—Ä–∞ (—Ç–∞–π–º–µ—Ä –ø—Ä–∞—Ü—é—î)
        let currentRoundWords = []; // –°–ª–æ–≤–∞, –ø–æ–∫–∞–∑–∞–Ω—ñ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —Ä–∞—É–Ω–¥—ñ, –¥–ª—è –ø—ñ–¥—Å—É–º–∫—ñ–≤
        let currentHostNickname = ''; // –ù—ñ–∫–Ω–µ–π–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è

        const MAX_SCORE = 30; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –ø–µ—Ä–µ–º–æ–≥–∏

        // –î–µ—Ñ–æ–ª—Ç–Ω—ñ —Ç–µ—Å—Ç–æ–≤—ñ —Å–ª–æ–≤–∞
        const defaultWords = [
            "–Ø–±–ª—É–∫–æ", "–ú–∞—à–∏–Ω–∞", "–°–æ–Ω—Ü–µ", "–ö–Ω–∏–≥–∞", "–î–µ—Ä–µ–≤–æ",
            "–ú–æ—Ä–µ", "–ì–æ—Ä–∞", "–ú—ñ—Å—Ç–æ", "–ö–≤—ñ—Ç–∫–∞", "–°–æ–±–∞–∫–∞",
            "–ö—ñ—à–∫–∞", "–ü—Ç–∞—Ö", "–†–∏–±–∞", "–•–º–∞—Ä–∞", "–ó—ñ—Ä–∫–∞",
            "–î–æ—â", "–í—ñ—Ç–µ—Ä", "–°–Ω—ñ–≥", "–í–æ–¥–∞", "–í–æ–≥–æ–Ω—å"
        ];

        // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó/–¥–æ–∫—É–º–µ–Ω—Ç–∏ Firestore
        let teamsCollectionRef;
        let gameWordsDocRef;
        let gameSettingsDocRef; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –≥—Ä–∏ (currentTeamIndex, currentWordIndex, gameActive)

        // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ---

        /**
         * –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É —É —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–º—É –±–ª–æ—Ü—ñ.
         * @param {string} message - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
         * @param {string} type - –¢–∏–ø –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ('success', 'error', 'info') –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó.
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'rounded-lg p-3 text-center active'; // –°–∫–∏–¥–∞—î–º–æ –∫–ª–∞—Å–∏ —Ç–∞ –∞–∫—Ç–∏–≤—É—î–º–æ
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            // –•–æ–≤–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
            setTimeout(() => {
                messageBox.classList.remove('active');
            }, 3000);
        }

        /**
         * –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –Ω—ñ–∫–Ω–µ–π–º—É –≥—Ä–∞–≤—Ü—è –≤ localStorage –±—Ä–∞—É–∑–µ—Ä–∞.
         */
        function saveNicknameLocally() {
            localStorage.setItem('aliasNickname', currentPlayer.nickname);
        }

        /**
         * –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Å—Ç–∞–Ω –∫–æ–º–∞–Ω–¥, –≥—Ä–∞–≤—Ü—è —Ç–∞ —Å–ª—ñ–≤ –∑ Firestore.
         */
        async function loadState() {
            db = window.db;
            auth = window.auth;
            userId = window.userId;
            appId = window.appId;

            if (!db || !auth || !userId) {
                console.error("Firebase not fully initialized.");
                return;
            }

            teamsCollectionRef = collection(db, `artifacts/${appId}/public/data/teams`);
            gameWordsDocRef = doc(db, `artifacts/${appId}/public/data/gameWords`);
            gameSettingsDocRef = doc(db, `artifacts/${appId}/public/data/gameSettings`);

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω—ñ–∫–Ω–µ–π–º –∑ localStorage
            const savedNickname = localStorage.getItem('aliasNickname');
            if (savedNickname) {
                currentPlayer.nickname = savedNickname;
                displayNickname.textContent = savedNickname;
            }

            // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ –∫–æ–º–∞–Ω–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
            onSnapshot(teamsCollectionRef, (snapshot) => {
                teams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTeams();
                checkGameReadiness();
            }, (error) => {
                console.error("Error listening to teams:", error);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥.", "error");
            });

            // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ —Å–ª—ñ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
            onSnapshot(gameWordsDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    words = docSnap.data().words || [];
                    shuffledWords = docSnap.data().shuffledWords || [];
                    currentWordIndex = docSnap.data().currentWordIndex || 0;
                } else {
                    words = [...defaultWords]; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ñ —Å–ª–æ–≤–∞, —è–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ–º–∞—î
                    shuffledWords = shuffleArray([...words]);
                    await setDoc(gameWordsDocRef, { words: words, shuffledWords: shuffledWords, currentWordIndex: 0 });
                }
                checkGameReadiness();
            }, (error) => {
                console.error("Error listening to words:", error);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ª—ñ–≤.", "error");
            });

            // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –≥—Ä–∏ (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó —Å—Ç–∞–Ω—É —Ä–∞—É–Ω–¥—É —Ç–∞ —Ö–æ—Å—Ç–∞)
            onSnapshot(gameSettingsDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    currentTeamIndex = settings.currentTeamIndex || 0;
                    gameActive = settings.gameActive || false;
                    currentPlayer.isHost = (settings.hostId === userId); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —Ö–æ—Å—Ç–∞
                    currentHostNickname = settings.hostNickname || '–ù–µ–≤—ñ–¥–æ–º–∏–π'; // –û–Ω–æ–≤–ª—é—î–º–æ –Ω—ñ–∫–Ω–µ–π–º —Ö–æ—Å—Ç–∞

                    // –Ø–∫—â–æ —Ö–æ—Å—Ç —â–µ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —ñ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –Ω—ñ–∫–Ω–µ–π–º, —Ä–æ–±–∏–º–æ –π–æ–≥–æ —Ö–æ—Å—Ç–æ–º
                    if (!settings.hostId && currentPlayer.nickname && userId) {
                        await updateDoc(gameSettingsDocRef, { hostId: userId, hostNickname: currentPlayer.nickname });
                        currentPlayer.isHost = true;
                        currentHostNickname = currentPlayer.nickname;
                    }

                    // –õ–æ–≥—ñ–∫–∞ –∑–∞–ø—É—Å–∫—É/–∑—É–ø–∏–Ω–∫–∏ —Ç–∞–π–º–µ—Ä–∞
                    if (gameActive && document.getElementById('game-section').classList.contains('active') && currentPlayer.isHost) {
                         // –¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –∑–∞–ø—É—Å–∫–∞—î —Ç–∞–π–º–µ—Ä
                        if (!timerInterval) { // –ó–∞–ø—É—Å–∫–∞—î–º–æ, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π
                            startTurnTimer();
                        }
                    } else if (!gameActive) {
                        clearInterval(timerInterval);
                        timerInterval = null; // –û—á–∏—â–∞—î–º–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª
                    }

                    // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏
                    if (teams[currentTeamIndex]) {
                        currentTeamTurnDisplayGame.textContent = teams[currentTeamIndex].name;
                    }
                    renderGameScores();

                    // –Ø–∫—â–æ gameActive false, –∞–ª–µ –º–∏ –≤ —ñ–≥—Ä–æ–≤—ñ–π —Å–µ–∫—Ü—ñ—ó, —î —Å–ª–æ–≤–∞ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —Ä–∞—É–Ω–¥—ñ, —ñ –ø—ñ–¥—Å—É–º–∫–∏ –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è
                    // –ó–Ω–∞—á–∏—Ç—å, —Ä–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è —ñ —Ç—Ä–µ–±–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–∏
                    if (!gameActive && document.getElementById('game-section').classList.contains('active') && currentRoundWords.length > 0 && roundSummaryDiv.style.display !== 'block') {
                         showRoundSummary();
                    }

                    updateHostUI(); // –û–Ω–æ–≤–ª—é—î–º–æ UI –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Å—Ç–∞—Ç—É—Å—É —Ö–æ—Å—Ç–∞
                } else {
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
                    // –¶–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
                    if (currentPlayer.nickname && userId) { // –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω—ñ–∫–Ω–µ–π–º –≤–∂–µ –≤–≤–µ–¥–µ–Ω–æ
                        await setDoc(gameSettingsDocRef, { currentTeamIndex: 0, gameActive: false, hostId: userId, hostNickname: currentPlayer.nickname });
                        currentPlayer.isHost = true;
                        currentHostNickname = currentPlayer.nickname;
                    } else {
                        // –Ø–∫—â–æ –Ω—ñ–∫–Ω–µ–π–º —â–µ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –±–µ–∑ —Ö–æ—Å—Ç–∞
                        await setDoc(gameSettingsDocRef, { currentTeamIndex: 0, gameActive: false, hostId: null, hostNickname: null });
                    }
                    updateHostUI();
                }
            }, (error) => {
                console.error("Error listening to game settings:", error);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –≥—Ä–∏.", "error");
            });

            // –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É —Å–µ–∫—Ü—ñ—é –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
            if (savedNickname) {
                showSection('main-actions-section');
            } else {
                showSection('nickname-section');
            }
            applySavedTheme(); // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É —Ç–µ–º—É
        }

        /**
         * –û–Ω–æ–≤–ª—é—î –µ–ª–µ–º–µ–Ω—Ç–∏ UI –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —á–∏ —î –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—Å—Ç–æ–º.
         */
        function updateHostUI() {
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ö–æ—Å—Ç–∞
            hostDisplayMain.textContent = `–•–æ—Å—Ç: ${currentHostNickname}`;
            hostDisplayGame.textContent = `–•–æ—Å—Ç: ${currentHostNickname}`;

            // –ö–Ω–æ–ø–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç—É
            startGameBtn.disabled = !currentPlayer.isHost;
            startGameBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ –≥—Ä—É.';

            startRoundBtn.disabled = !currentPlayer.isHost;
            startRoundBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ —Ä–∞—É–Ω–¥.';

            startNextRoundBtn.disabled = !currentPlayer.isHost;
            startNextRoundBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä–∞—É–Ω–¥.';

            confirmRoundSummaryBtn.disabled = !currentPlayer.isHost;
            confirmRoundSummaryBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø—ñ–¥—Å—É–º–∫–∏.';

            correctBtn.disabled = !currentPlayer.isHost;
            correctBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –≤—ñ–¥–º—ñ—á–∞—Ç–∏ —Å–ª–æ–≤–∞.';

            skipBtn.disabled = !currentPlayer.isHost;
            skipBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç–∏ —Å–ª–æ–≤–∞.';

            endGameBtn.disabled = !currentPlayer.isHost;
            endGameBtn.title = currentPlayer.isHost ? '' : '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –≥—Ä—É.';
        }


        /**
         * –•–æ–≤–∞—î –≤—Å—ñ —Å–µ–∫—Ü—ñ—ó, –æ–∫—Ä—ñ–º teams-display-section, —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –≤–∫–∞–∑–∞–Ω—É.
         * @param {string} sectionId - ID —Å–µ–∫—Ü—ñ—ó, —è–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏.
         */
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            if (sectionId !== 'nickname-section') {
                teamsDisplaySection.classList.add('active');
            } else {
                teamsDisplaySection.classList.remove('active');
            }
        }

        /**
         * –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –ø–æ—Ç–æ—á–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ —ó—Ö–Ω—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ –≤ UI.
         */
        function renderTeams() {
            leftTeamsList.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –æ–±–∏–¥–≤–∞ —Å–ø–∏—Å–∫–∏
            rightTeamsList.innerHTML = '';

            if (teams.length === 0) {
                leftTeamsList.innerHTML = '<p class="text-gray-500 text-center col-span-full">–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –∫–æ–º–∞–Ω–¥. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤—É!</p>';
                joinTeamOptionBtn.disabled = true;
                startGameBtn.disabled = true;
                return;
            }
            joinTeamOptionBtn.disabled = false;

            teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card rounded-lg p-4 bg-indigo-100 shadow-md';
                teamCard.innerHTML = `
                    <h3 class="text-xl font-bold text-indigo-800 mb-2">${team.name} <span class="text-lg text-indigo-600">(${team.score} –±–∞–ª—ñ–≤)</span></h3>
                    <ul class="list-none p-0 m-0">
                        ${team.members.length > 0 ?
                            team.members.map(member => `<li class="bg-indigo-200 text-indigo-900 px-3 py-1 rounded-md mb-1">${member}</li>`).join('') :
                            '<li class="text-indigo-600">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≥—Ä–∞–≤—Ü—ñ–≤</li>'
                        }
                    </ul>
                `;
                if (index % 2 === 0) { // –†–æ–∑–ø–æ–¥—ñ–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥–∏ –ø–æ –ª—ñ–≤—ñ–π —Ç–∞ –ø—Ä–∞–≤—ñ–π –∫–æ–ª–æ–Ω–∫–∞—Ö
                    leftTeamsList.appendChild(teamCard);
                } else {
                    rightTeamsList.appendChild(teamCard);
                }
            });
            checkGameReadiness();
            renderGameScores(); // –ó–∞–≤–∂–¥–∏ –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–∞—Ö—É–Ω–∫–∏ –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –∫–æ–º–∞–Ω–¥
        }

        /**
         * –ó–∞–ø–æ–≤–Ω—é—î –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ–º–∞–Ω–¥–∏.
         */
        function populateTeamSelect() {
            teamSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É...</option>';
            teams.forEach((team, index) => {
                const option = document.createElement('option');
                option.value = team.id; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ Firestore
                option.textContent = `${team.name} (${team.members.length} –≥—Ä–∞–≤—Ü—ñ–≤)`;
                teamSelect.appendChild(option);
            });
            joinSelectedTeamBtn.disabled = true;
            teamSelect.addEventListener('change', () => {
                joinSelectedTeamBtn.disabled = teamSelect.value === '';
            });
        }

        /**
         * –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ–º–∞–Ω–¥ —Ç–∞ —Å–ª—ñ–≤ –¥–ª—è –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏.
         * –í–º–∏–∫–∞—î/–≤–∏–º–∏–∫–∞—î –∫–Ω–æ–ø–∫—É "–ü–æ—á–∞—Ç–∏ –≥—Ä—É".
         */
        function checkGameReadiness() {
            const hasEnoughTeams = teams.length >= 1 && teams.every(team => team.members.length > 0);
            const hasWords = words.length > 0;
            startGameBtn.disabled = !(hasEnoughTeams && hasWords) || !currentPlayer.isHost; // –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Ö–æ—Å—Ç–∞
            if (!hasEnoughTeams) {
                startGameBtn.title = '–î–ª—è –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –º—ñ–Ω—ñ–º—É–º 1 –∫–æ–º–∞–Ω–¥–∞, —ñ –≤ –Ω—ñ–π –º–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å.';
            } else if (!hasWords) {
                startGameBtn.title = '–î–ª—è –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–æ–≤–∞.';
            } else if (!currentPlayer.isHost) {
                startGameBtn.title = '–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ –≥—Ä—É.';
            }
            else {
                startGameBtn.title = '';
            }
        }

        /**
         * –ü–µ—Ä–µ–º—ñ—à—É—î –º–∞—Å–∏–≤ —Å–ª—ñ–≤.
         * @param {Array} array - –ú–∞—Å–∏–≤ –¥–ª—è –ø–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è.
         * @returns {Array} –ü–µ—Ä–µ–º—ñ—à–∞–Ω–∏–π –º–∞—Å–∏–≤.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * –û–Ω–æ–≤–ª—é—î –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª—ñ–≤ –∫–æ–º–∞–Ω–¥ –ø—ñ–¥ —á–∞—Å –≥—Ä–∏.
         */
        function renderGameScores() {
            gameScoresDisplay.innerHTML = '';
            teams.forEach(team => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'game-score-item';
                scoreItem.innerHTML = `${team.name}: <span>${team.score}</span>`;
                gameScoresDisplay.appendChild(scoreItem);
            });
        }

        /**
         * –ì–æ—Ç—É—î UI –¥–ª—è –ø–æ—á–∞—Ç–∫—É –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥—É (–ø–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫—É "–ü–æ—á–∞—Ç–∏ —Ä–∞—É–Ω–¥").
         */
        async function prepareForTurn() {
            clearInterval(timerInterval);
            gameActive = false;
            await updateDoc(gameSettingsDocRef, { gameActive: false }); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –≥—Ä–∏ —É Firestore

            currentWordDisplay.style.display = 'none';
            peekingMessage.style.display = 'flex';
            correctBtn.style.display = 'none';
            skipBtn.style.display = 'none';
            roundSummaryDiv.style.display = 'none';
            startNextRoundBtn.style.display = 'none';
            confirmRoundSummaryBtn.style.display = 'none';

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏, —è–∫–∞ –º–∞—î –≥—Ä–∞–≤—Ü—ñ–≤
            let originalTeamIndex = currentTeamIndex;
            do {
                currentTeamIndex = (currentTeamIndex + 1) % teams.length;
                if (teams[currentTeamIndex].members.length > 0) {
                    break;
                }
            } while (currentTeamIndex !== originalTeamIndex);

            if (teams[currentTeamIndex].members.length === 0) {
                showMessage('–ù–µ–º–∞—î –∫–æ–º–∞–Ω–¥ –∑ –≥—Ä–∞–≤—Ü—è–º–∏. –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.', 'error');
                endGame();
                return;
            }

            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–¥–µ–∫—Å –ø–æ—Ç–æ—á–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏ —É Firestore
            await updateDoc(gameSettingsDocRef, { currentTeamIndex: currentTeamIndex });

            currentTeamTurnDisplayGame.textContent = teams[currentTeamIndex].name;
            timerDisplay.textContent = '60';
            timerDisplay.classList.remove('text-red-600');

            startRoundBtn.style.display = 'block';
            renderGameScores();
        }

        /**
         * –ó–∞–ø—É—Å–∫–∞—î —Ç–∞–π–º–µ—Ä —Ä–∞—É–Ω–¥—É.
         */
        function startTurnTimer() {
            clearInterval(timerInterval); // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–∞–π–º–µ—Ä, —è–∫—â–æ –≤—ñ–Ω –±—É–≤
            gameTimer = 60; // –°–∫–∏–¥–∞—î–º–æ —Ç–∞–π–º–µ—Ä
            timerDisplay.textContent = gameTimer;
            timerDisplay.classList.remove('text-red-600');

            timerInterval = setInterval(() => {
                gameTimer--;
                timerDisplay.textContent = gameTimer;
                if (gameTimer <= 10) {
                    timerDisplay.classList.add('text-red-600');
                } else {
                    timerDisplay.classList.remove('text-red-600');
                }

                if (gameTimer <= 0) {
                    clearInterval(timerInterval);
                    gameActive = false;
                    updateDoc(gameSettingsDocRef, { gameActive: false }); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –≥—Ä–∏ —É Firestore
                    showMessage(`–ß–∞—Å –≤–∏–π—à–æ–≤ –¥–ª—è ${teams[currentTeamIndex].name}! –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–∞—É–Ω–¥—É.`, 'info');
                    showRoundSummary();
                }
            }, 1000);
        }


        /**
         * –ü–æ—á–∏–Ω–∞—î –Ω–æ–≤–∏–π —Ö—ñ–¥ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏.
         */
        async function startTurn() {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ —Ä–∞—É–Ω–¥.', 'error');
                return;
            }

            gameActive = true;
            await updateDoc(gameSettingsDocRef, { gameActive: true }); // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –≥—Ä–∏ —É Firestore

            startRoundBtn.style.display = 'none';
            startNextRoundBtn.style.display = 'none';
            roundSummaryDiv.style.display = 'none';
            confirmRoundSummaryBtn.style.display = 'none';

            peekingMessage.style.display = 'none';
            currentWordDisplay.style.display = 'flex';
            correctBtn.style.display = 'block';
            skipBtn.style.display = 'block';

            currentRoundWords = []; // –û—á–∏—â–∞—î–º–æ —Å–ª–æ–≤–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ä–∞—É–Ω–¥—É

            const currentTeam = teams[currentTeamIndex];
            currentTeamTurnDisplayGame.textContent = currentTeam.name;
            
            displayNextWord(); // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à–µ —Å–ª–æ–≤–æ –¥–ª—è —Ü—å–æ–≥–æ —Ö–æ–¥—É
            renderGameScores();

            startTurnTimer(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–∞–π–º–µ—Ä
        }

        /**
         * –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –Ω–∞—Å—Ç—É–ø–Ω–µ —Å–ª–æ–≤–æ –∑ –ø–µ—Ä–µ–º—ñ—à–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É.
         */
        async function displayNextWord() {
            if (currentWordIndex < shuffledWords.length) {
                currentWordDisplay.textContent = shuffledWords[currentWordIndex];
                currentWordIndex++;
                await updateDoc(gameWordsDocRef, { currentWordIndex: currentWordIndex });
            } else {
                // –°–ª–æ–≤–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è, –≥—Ä–∞ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è
                clearInterval(timerInterval);
                gameActive = false;
                await updateDoc(gameSettingsDocRef, { gameActive: false });
                showMessage('–£—Å—ñ —Å–ª–æ–≤–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è! –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.', 'info');
                endGame();
            }
        }

        /**
         * –û–±—Ä–æ–±–ª—è—î –ø—Ä–∞–≤–∏–ª—å–Ω–µ –≤—ñ–¥–≥–∞–¥—É–≤–∞–Ω–Ω—è —Å–ª–æ–≤–∞.
         */
        async function handleCorrect() {
            if (!gameActive || !currentPlayer.isHost) return; // –¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –≤—ñ–¥–º—ñ—á–∞—Ç–∏
            const word = currentWordDisplay.textContent;
            const currentTeam = teams[currentTeamIndex];
            currentTeam.score++;
            currentRoundWords.push({ word: word, score: 1 });
            await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, currentTeam.id), { score: currentTeam.score });

            if (currentTeam.score >= MAX_SCORE) {
                showMessage(`${currentTeam.name} –ø–µ—Ä–µ–º–æ–≥–ª–∞!`, 'success');
                endGame();
                return;
            }
            renderGameScores();
            displayNextWord();
        }

        /**
         * –û–±—Ä–æ–±–ª—è—î –ø—Ä–æ–ø—É—Å–∫ —Å–ª–æ–≤–∞.
         */
        async function handleSkip() {
            if (!gameActive || !currentPlayer.isHost) return; // –¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç–∏
            const word = currentWordDisplay.textContent;
            const currentTeam = teams[currentTeamIndex];
            currentTeam.score--;
            currentRoundWords.push({ word: word, score: -1 });
            await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, currentTeam.id), { score: currentTeam.score });

            renderGameScores();
            displayNextWord();
        }

        /**
         * –í—ñ–¥–æ–±—Ä–∞–∂–∞—î –ø—ñ–¥—Å—É–º–∫–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–∞—É–Ω–¥—É.
         */
        function showRoundSummary() {
            clearInterval(timerInterval);
            gameActive = false;

            currentWordDisplay.style.display = 'none';
            peekingMessage.style.display = 'none';
            correctBtn.style.display = 'none';
            skipBtn.style.display = 'none';
            startNextRoundBtn.style.display = 'none';
            startRoundBtn.style.display = 'none';

            roundSummaryDiv.style.display = 'block';
            confirmRoundSummaryBtn.style.display = 'block';

            summaryTeamName.textContent = teams[currentTeamIndex].name;
            wordsInRoundList.innerHTML = '';

            if (currentRoundWords.length === 0) {
                wordsInRoundList.innerHTML = '<p class="text-gray-600 text-center">–£ —Ü—å–æ–º—É —Ä–∞—É–Ω–¥—ñ —Å–ª—ñ–≤ –Ω–µ –±—É–ª–æ.</p>';
                return;
            }

            currentRoundWords.forEach((item, index) => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-score-item';
                wordItem.innerHTML = `
                    <span>${item.word}</span>
                    <div class="score-controls flex items-center">
                        <span id="score-display-${index}" class="current-word-score">${item.score}</span>
                        <button data-index="${index}" data-score="-1" class="${item.score === -1 ? 'active' : ''}" ${!currentPlayer.isHost ? 'disabled' : ''}>-1</button>
                        <button data-index="${index}" data-score="0" class="${item.score === 0 ? 'active' : ''}" ${!currentPlayer.isHost ? 'disabled' : ''}>0</button>
                        <button data-index="${index}" data-score="1" class="${item.score === 1 ? 'active' : ''}" ${!currentPlayer.isHost ? 'disabled' : ''}>+1</button>
                    </div>
                `;
                wordsInRoundList.appendChild(wordItem);

                wordItem.querySelectorAll('.score-controls button').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        if (!currentPlayer.isHost) { // –¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∫–æ—Ä–∏–≥—É–≤–∞—Ç–∏ –±–∞–ª–∏
                            showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∫–æ—Ä–∏–≥—É–≤–∞—Ç–∏ –±–∞–ª–∏.', 'error');
                            return;
                        }

                        const btn = event.target;
                        const wordIdx = parseInt(btn.dataset.index);
                        const newScore = parseInt(btn.dataset.score);

                        const oldScore = currentRoundWords[wordIdx].score;
                        const scoreDifference = newScore - oldScore;

                        currentRoundWords[wordIdx].score = newScore;
                        const currentTeam = teams[currentTeamIndex];
                        currentTeam.score += scoreDifference;

                        await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, currentTeam.id), { score: currentTeam.score });

                        document.getElementById(`score-display-${wordIdx}`).textContent = newScore;

                        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        renderGameScores();
                    });
                });
            });
        }

        /**
         * –ü—Ä–∏—Ö–æ–≤—É—î –ø—ñ–¥—Å—É–º–∫–∏ —Ä–∞—É–Ω–¥—É —Ç–∞ –ø–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫—É "–ü–æ—á–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä–∞—É–Ω–¥".
         */
        function confirmRoundSummary() {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–∞—É–Ω–¥—É.', 'error');
                return;
            }
            roundSummaryDiv.style.display = 'none';
            confirmRoundSummaryBtn.style.display = 'none';
            // –ü—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—ñ–≤, –≥–æ—Ç—É—î–º–æ UI –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ö–æ–¥—É (—è–∫–∏–π –ø–æ–∫–∞–∂–µ startRoundBtn)
            prepareForTurn();
        }


        /**
         * –ó–∞–≤–µ—Ä—à—É—î –ø–æ—Ç–æ—á–Ω—É –≥—Ä—É.
         */
        async function endGame() {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –≥—Ä—É.', 'error');
                return;
            }
            clearInterval(timerInterval);
            gameActive = false;
            await updateDoc(gameSettingsDocRef, { gameActive: false, currentTeamIndex: 0 });
            await updateDoc(gameWordsDocRef, { shuffledWords: shuffleArray([...words]), currentWordIndex: 0 });

            // –°–∫–∏–¥–∞—î–º–æ —Ä–∞—Ö—É–Ω–∫–∏ –≤—Å—ñ—Ö –∫–æ–º–∞–Ω–¥ —É Firestore
            for (const team of teams) {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, team.id), { score: 0 });
            }

            renderTeams();
            showSection('main-actions-section');
            showMessage('–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–∞—Ö—É–Ω–∫–∏ —Å–∫–∏–Ω—É—Ç–æ.', 'info');
            currentWordDisplay.textContent = '';
            peekingMessage.style.display = 'none';
            timerDisplay.textContent = '60';
            startRoundBtn.style.display = 'none';
            startNextRoundBtn.style.display = 'none';
            roundSummaryDiv.style.display = 'none';
            confirmRoundSummaryBtn.style.display = 'none';
        }

        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π ---

        continueBtn.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                currentPlayer.nickname = nickname;
                saveNicknameLocally(); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω—ñ–∫–Ω–µ–π–º –ª–æ–∫–∞–ª—å–Ω–æ
                displayNickname.textContent = nickname;
                showSection('main-actions-section');
                // –ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤—Ö–æ–¥—ñ, —è–∫—â–æ —Ö–æ—Å—Ç —â–µ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π, –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–∞–Ω–µ —Ö–æ—Å—Ç–æ–º
                // –¶–µ –±—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –≤ onSnapshot –¥–ª—è gameSettingsDocRef
            } else {
                showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω—ñ–∫–Ω–µ–π–º.', 'error');
            }
        });

        createTeamOptionBtn.addEventListener('click', () => {
            showSection('create-team-section');
            numTeamsInput.value = Math.max(2, Math.min(5, teams.length > 0 ? teams.length : 2));
        });

        joinTeamOptionBtn.addEventListener('click', () => {
            if (teams.length === 0) {
                showMessage('–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É —Å–ø–æ—á–∞—Ç–∫—É.', 'error');
                return;
            }
            populateTeamSelect();
            showSection('join-team-section');
        });

        backToNicknameBtn.addEventListener('click', async () => {
            if (currentPlayer.nickname && currentPlayer.team) {
                const teamToUpdate = teams.find(team => team.name === currentPlayer.team);
                if (teamToUpdate) {
                    const updatedMembers = teamToUpdate.members.filter(member => member !== currentPlayer.nickname);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, teamToUpdate.id), { members: updatedMembers });
                }
            }
            localStorage.removeItem('aliasNickname'); // –í–∏–¥–∞–ª—è—î–º–æ –Ω—ñ–∫–Ω–µ–π–º –∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞
            currentPlayer.nickname = '';
            currentPlayer.team = '';
            // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–≤ —Ö–æ—Å—Ç–æ–º, —Å–∫–∏–¥–∞—î–º–æ —Ö–æ—Å—Ç–∞ —É Firestore
            if (currentPlayer.isHost) {
                await updateDoc(gameSettingsDocRef, { hostId: null, hostNickname: null });
                currentPlayer.isHost = false;
                currentHostNickname = '';
            }
            renderTeams();
            showSection('nickname-section');
        });

        backToMainActionsBtnFromCreate.addEventListener('click', () => {
            showSection('main-actions-section');
        });

        backToMainActionsBtnFromJoin.addEventListener('click', () => {
            showSection('main-actions-section');
        });

        backToMainActionsBtnFromWords.addEventListener('click', () => {
            showSection('main-actions-section');
        });

        createTeamsBtn.addEventListener('click', async () => {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏.', 'error');
                return;
            }

            const numTeams = parseInt(numTeamsInput.value);
            if (isNaN(numTeams) || numTeams < 2 || numTeams > 5) {
                showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 2 –¥–æ 5.', 'error');
                return;
            }

            // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ –∫–æ–º–∞–Ω–¥–∏ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–∏—Ö
            const existingTeamsSnapshot = await getDocs(teamsCollectionRef);
            for (const teamDoc of existingTeamsSnapshot.docs) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/teams`, teamDoc.id));
            }

            const newTeamsData = [];
            for (let i = 1; i <= numTeams; i++) {
                const newTeam = { name: `–ö–æ–º–∞–Ω–¥–∞ ${i}`, members: [], score: 0 };
                newTeam.members.push(`–ë–æ—Ç ${i}-1`);
                newTeam.members.push(`–ë–æ—Ç ${i}-2`);
                newTeamsData.push(newTeam);
            }

            // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –∫–æ–º–∞–Ω–¥–∏ –¥–æ Firestore
            for (const teamData of newTeamsData) {
                await addDoc(teamsCollectionRef, teamData);
            }

            // –ü—Ä–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è –¥–æ –ø–µ—Ä—à–æ—ó –∫–æ–º–∞–Ω–¥–∏, —è–∫—â–æ –≤—ñ–Ω —î
            if (currentPlayer.nickname) {
                // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω `teams` –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥
                const updatedTeamsSnapshot = await getDocs(teamsCollectionRef);
                teams = updatedTeamsSnapshot.docs.map(teamDoc => ({ id: teamDoc.id, ...teamDoc.data() }));

                const firstTeam = teams[0];
                if (firstTeam && !firstTeam.members.includes(currentPlayer.nickname)) {
                    const updatedMembers = [...firstTeam.members, currentPlayer.nickname];
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, firstTeam.id), { members: updatedMembers });
                    currentPlayer.team = firstTeam.name;
                    showMessage(`–°—Ç–≤–æ—Ä–µ–Ω–æ ${numTeams} –∫–æ–º–∞–Ω–¥! ${currentPlayer.nickname} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ ${firstTeam.name}.`, 'success');
                } else {
                    showMessage(`–°—Ç–≤–æ—Ä–µ–Ω–æ ${numTeams} –∫–æ–º–∞–Ω–¥!`, 'success');
                }
            } else {
                showMessage(`–°—Ç–≤–æ—Ä–µ–Ω–æ ${numTeams} –∫–æ–º–∞–Ω–¥! –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º, —â–æ–± –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è.`, 'info');
            }
            renderTeams();
            showSection('main-actions-section');
        });

        joinSelectedTeamBtn.addEventListener('click', async () => {
            const selectedTeamId = teamSelect.value;
            if (selectedTeamId === '') {
                showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É.', 'error');
                return;
            }

            if (currentPlayer.nickname) {
                // –í–∏–¥–∞–ª—è—î–º–æ –≥—Ä–∞–≤—Ü—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∫–æ–º–∞–Ω–¥–∏ —É Firestore, —è–∫—â–æ –≤—ñ–Ω –±—É–≤ —É –Ω—ñ–π
                if (currentPlayer.team) {
                    const prevTeam = teams.find(team => team.id === currentPlayer.team);
                    if (prevTeam) {
                        const updatedMembers = prevTeam.members.filter(member => member !== currentPlayer.nickname);
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, prevTeam.id), { members: updatedMembers });
                    }
                }

                // –î–æ–¥–∞—î–º–æ –≥—Ä–∞–≤—Ü—è –¥–æ –Ω–æ–≤–æ—ó –∫–æ–º–∞–Ω–¥–∏ —É Firestore
                const selectedTeam = teams.find(team => team.id === selectedTeamId);
                if (selectedTeam) {
                    const updatedMembers = [...selectedTeam.members, currentPlayer.nickname];
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, selectedTeam.id), { members: updatedMembers });
                    currentPlayer.team = selectedTeam.name;
                    showMessage(`${currentPlayer.nickname} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ ${selectedTeam.name}!`, 'success');
                }
            } else {
                showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º, –ø–µ—Ä—à –Ω—ñ–∂ –ø—Ä–∏—î–¥–Ω—É–≤–∞—Ç–∏—Å—è –¥–æ –∫–æ–º–∞–Ω–¥–∏.', 'error');
            }

            renderTeams();
            showSection('main-actions-section');
        });

        loadWordsOptionBtn.addEventListener('click', () => {
            showSection('word-input-section');
            wordsTextarea.value = words.join('\n');
        });

        loadWordsBtn.addEventListener('click', async () => {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Å–ª–æ–≤–∞.', 'error');
                return;
            }

            const rawWords = wordsTextarea.value.split('\n').map(word => word.trim()).filter(word => word.length > 0);
            if (rawWords.length === 0) {
                showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ —Å–ª–æ–≤–æ.', 'error');
                return;
            }
            words = rawWords;
            shuffledWords = shuffleArray([...words]); // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ —Å–ª–æ–≤–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            currentWordIndex = 0;
            try {
                await setDoc(gameWordsDocRef, { words: words, shuffledWords: shuffledWords, currentWordIndex: currentWordIndex });
                showMessage(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${words.length} —Å–ª—ñ–≤!`, 'success');
            } catch (e) {
                console.error("Error writing words to Firestore:", e);
                showMessage("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ª—ñ–≤ —É —Ö–º–∞—Ä—É.", "error");
            }
            showSection('main-actions-section');
            checkGameReadiness();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—á–∞—Ç–∏ –≥—Ä—É" (—ñ–Ω—ñ—Ü—ñ—é—î –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É –¥–æ –ø–µ—Ä—à–æ–≥–æ —Ä–∞—É–Ω–¥—É)
        startGameBtn.addEventListener('click', async () => {
            if (!currentPlayer.isHost) {
                showMessage('–¢—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ –≥—Ä—É.', 'error');
                return;
            }

            if (!gameActive) {
                if (teams.length < 1 || teams.some(team => team.members.length === 0)) {
                    showMessage('–î–ª—è –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –º—ñ–Ω—ñ–º—É–º 1 –∫–æ–º–∞–Ω–¥–∞, —ñ –≤ –Ω—ñ–π –º–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å.', 'error');
                    return;
                }
                if (words.length === 0) {
                    showMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –≥—Ä–∏.', 'error');
                    return;
                }

                // –°–∫–∏–¥–∞—î–º–æ —Ä–∞—Ö—É–Ω–∫–∏ –≤—Å—ñ—Ö –∫–æ–º–∞–Ω–¥ —É Firestore –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –Ω–æ–≤–æ—ó –≥—Ä–∏
                for (const team of teams) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/teams`, team.id), { score: 0 });
                }
                // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ —Å–ª–æ–≤–∞ —Ç–∞ —Å–∫–∏–¥–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å —Å–ª–æ–≤–∞ —É Firestore
                shuffledWords = shuffleArray([...words]);
                currentWordIndex = 0;
                await updateDoc(gameWordsDocRef, { shuffledWords: shuffledWords, currentWordIndex: currentWordIndex });

                currentTeamIndex = -1; // –©–æ–± prepareForTurn() –ø–æ—á–∞–≤ –∑ –ö–æ–º–∞–Ω–¥–∏ 1 (—ñ–Ω–¥–µ–∫—Å 0)
                gameActive = false; // –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ, —â–æ –≥—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ –ø–æ—á–∞—Ç–∫—É —Ä–∞—É–Ω–¥—É
                await updateDoc(gameSettingsDocRef, { currentTeamIndex: currentTeamIndex, gameActive: gameActive }); // –û–Ω–æ–≤–ª—é—î–º–æ Firestore

                showSection('game-section');
                prepareForTurn();
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≥—Ä–∏
        correctBtn.addEventListener('click', handleCorrect);
        skipBtn.addEventListener('click', handleSkip);
        endGameBtn.addEventListener('click', endGame);
        startRoundBtn.addEventListener('click', startTurn);
        startNextRoundBtn.addEventListener('click', startTurn);
        confirmRoundSummaryBtn.addEventListener('click', confirmRoundSummary);

        // --- –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ ---
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è'; // –Ü–∫–æ–Ω–∫–∞ —Å–æ–Ω—Ü—è –¥–ª—è —Å–≤—ñ—Ç–ª–æ—ó —Ç–µ–º–∏
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô'; // –Ü–∫–æ–Ω–∫–∞ –º—ñ—Å—è—Ü—è –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏
            }
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            }
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –≥—Ä–∏ —Ç–∞ —Ç–µ–º–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        // –¶–µ–π –≤–∏–∫–ª–∏–∫ —Ç–µ–ø–µ—Ä –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase –≤ onAuthStateChanged
        // document.addEventListener('DOMContentLoaded', loadState); // –ó–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ, –æ—Å–∫—ñ–ª—å–∫–∏ loadState –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –≤ onAuthStateChanged
        document.addEventListener('DOMContentLoaded', applySavedTheme); // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç–µ–º—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ DOM
    </script>
</body>
</html>
